{% extends "skeleton.html" %}
{% load flatcontent_tags mtags %}

{% block extrahead %}
<style type="text/css">
  .fr-pop-tabs {
    height: auto;
  }
  .fr-pop-tabs li {
    float: none;
  }
  p.title {
    font-size: 120%;
    margin-bottom: 20px;
  }
  p.title strong {
    font-weight: bold;
  }
  .form-field {
    margin: 0 0 15px;
  }
  #profile h5.panel-title {
    color: #fff;
    font-size: 20px;
  }
  .faq .panel-default .no-transform .fa {
    -webkit-transform: none;
    transform: none;
    float: none;
  }
  #confirm_phone_button {
    margin: 0;
  }
</style>
{% endblock %}

{% block content %}
<section id="profile">
  <div class="padding-masc">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-12 faq-text">
          <h3>Добро пожаловать, {{ shopper.name }} в ваш личный кабинет</h3>
          <div class="faq">
            <div class="panel-group" id="accordion">
              <!-- Профиль -->
              <div class="panel panel-default text-left">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapse_profile">
                  <div class="panel-heading">
                    <h5 class="panel-title">Ваш профиль
                      <i class="fa fa-chevron-circle-down" aria-hidden="true"></i>
                    </h5>
                  </div>
                </a>
                <div id="collapse_profile" class="panel-collapse collapse in">
                  <div class="panel-body">
                    {% include "web/login/profile_form.html" %}
                  </div>
                </div>
              </div>

              <!-- История звонков -->
              <div class="panel panel-default text-left">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapse_call_history">
                  <div class="panel-heading">
                    <h5 class="panel-title">История звонков
                      <i class="fa fa-chevron-circle-down" aria-hidden="true"></i>
                    </h5>
                  </div>
                </a>
                <div id="collapse_call_history" class="panel-collapse collapse">
                  <div class="panel-body">
                    ---
                  </div>
                </div>
              </div>

              <!-- Подтверждение телефона -->
              <div class="panel panel-default text-left">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapse_confirm_phone">
                  <div class="panel-heading">
                    <h5 class="panel-title">Подтвердить телефон
                      <i class="fa fa-chevron-circle-down" aria-hidden="true"></i>
                    </h5>
                  </div>
                </a>
                <div id="collapse_confirm_phone" class="panel-collapse collapse">
                  <div class="panel-body">
                    <h3>Ваш телефон: {{ shopper.phone }}</h3>
                    {% if shopper.phone_confirmed %}
                      <div class="col-sm-6 mb-20 text-center no-transform">
                        <label id="confirm_phone_label">Телефон подтвержден</label><br>
                      </div>
                    {% else %}
                      <div class="col-sm-6 mb-20 text-center no-transform">
                        <label id="confirm_phone_label">Телефон не подтвержден</label><br>
                        <button class="btn dwnld-btn playmarket" id="confirm_phone_button"><i class="fa fa-shield"></i> Подтвердить</button>
                      </div>
                      <div class="col-sm-6 mb-20 text-center">
                        <label>Проверочный код</label>
                        <input placeholder="Проверочный код" type="text" id="confirm_phone_field">
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        <div class="col-xs-12 col-md-6 col-md-pull-6 text-center">
          <div class="ilustration">
            {% for block in blocks %}
              {% if block.img %}
                <div class="{% cycle 'back' 'front' %}-phone wow slideInUp" data-wow-duration="1.3s" data-wow-delay=".2s">
                  <div class="iphone-x">
                    <i></i>
                    <b></b>
                    <img src="{% imagine block.img '800x800' block.get_folder True %}" alt="{{ block.name|textize }}" loading="lazy">
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% for container in page.containers %}
  {% flatcontent request page container.container.tag %}
{% endfor %}
{% endblock %}

{% block subscribe %}{% endblock %}

{% block extrascripts %}
<script src="/static/js/jquery.form.min.js"></script>
<script src="/static/js/jquery.validate.min.js"></script>
<script src="/static/js/jquery.maskedinput.min.js"></script>
<script src="/static/js/feedback.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    var profile = new FeedBack("profile_form", {
      "wait": "Ждите...",
      //"send": "Отправить",
      "success": "Профиль обновлен",
      "progress": "Пожалуйста, ждите...",
      "error": "Произошла ошибка, сообщите нам по телефону",
      "error_captcha": "Не пройдена проверка на работа",
      "callback_success": "",
      "callback_error": "",
      "dont_reset_on_submit": 1, // or 1
      //"errorClass": "invalid",
    });

    $("#confirm_phone_field").keyup(function(){
      var value = $(this).val();
      if(value.length == 4){
        jQuery.ajax({
          async : true,
          type: "GET",
          url: "/confirm_phone/",
          data : "digits=" + value,
          success: function (r){
            if(r['success']){
              $("#confirm_phone_label").html("Телефон подтвержден");
              $("#confirm_phone_button").prop('disabled', true);
              $("#confirm_phone_button").hide();
              $("#confirm_phone_field").prop('disabled', true);
            }
          }
        });
      }
    });

    $("#confirm_phone_button").click(function(){
      var phone = parseInt($("#profile_form .phone").val().replace("(", "").replace(")", "").replace("-", "").replace(" ", ""));
      if(phone.isNaN){
        alert("Телефон введен неправильно");
        return;
      }
      var phone_str = phone + "";
      if(phone_str.length !== 11 || phone_str[0] !== '8' || phone_str[1] !== '9'){
        alert("Телефон введен неправильно");
        return;
      }
      $("#confirm_phone_button").prop('disabled', true);
      jQuery.ajax({
        async : true,
        type: "GET",
        url: "/confirm_phone/",
        data : "phone=" + phone,
        success: function (r){
          console.log(r);
        }
      });
    });

  });
</script>
{% endblock %}